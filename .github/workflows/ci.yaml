---
name: CI

on:
  pull_request:
    branches:
      - main

permissions: read-all

jobs:
  lint-build-structure-scan:
    name: Lint, Build, Structure Test, and Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      matrix:
        platform: [ "amd64", "arm64", "386", "arm/v7", arm/v6 ]
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

      - name: Prepare Environment
        id: prepare_environment
        run: |
          echo "build_created=$( date --utc +"%Y-%m-%dT%H:%M:%SZ" )" >> "${GITHUB_ENV}"
          echo "build_revision=$( echo "${{ github.sha }}" )" >> "${GITHUB_ENV}"
          echo "build_version=$( echo "${{ github.sha }}" )" >> "${GITHUB_ENV}"

      - name: Set up Docker QEMU
        id: setup_qemu
        uses: docker/setup-qemu-action@2b82ce82d56a2a04d2637cd93a637ae1b359c0a7 # v2.2.0

      - name: Set up Docker Buildx
        id: setup_buildx
        uses: docker/setup-buildx-action@6a58db7e0d21ca03e6c44877909e80e45217eed2 # v2.6.0

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        id: hadolint
        with:
          dockerfile: Dockerfile

      - name: Build Image
        id: build_image
        uses: docker/build-push-action@44ea916f6c540f9302d50c2b1e5a8dc071f15cdf # v4.1.0
        with:
          file: Dockerfile
          context: .
          platforms: linux/${{ matrix.platform }}
          load: true
          tags: |
            doh-proxy:${{ github.sha }}
          build-args: |
            BUILD_CREATED=${{ env.build_created }}
            BUILD_REVISION=${{ env.build_revision }}
            BUILD_VERSION=${{ env.build_version }}

      - name: Container Structure Test
        id: container_structure_test
        uses: docker://gcr.io/gcp-runtimes/container-structure-test:latest
        with:
          args: test --image doh-proxy:${{ github.sha }} --config container-structure-test.yaml

      - name: Trivy Scan
        id: trivy_scan
        uses: aquasecurity/trivy-action@0cd397afbfae6b60e8061fda662f3511aa5d054e # v0.11.1
        continue-on-error: true
        with:
          image-ref: doh-proxy:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy Scan SARIF report
        id: upload_trivy_sarif
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        with:
          sarif_file: trivy-results.sarif

  test-providers:
    name: Test Providers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

      - name: Test Providers
        id: test_providers
        run: |
          sudo apt install --yes dnsutils
          bash scripts/provider-test.sh
        env:
          CLOUDFLARE_ZERO_TRUST_ID: ${{ secrets.CLOUDFLARE_ZERO_TRUST_ID }}
          NEXTDNS_ID: ${{ secrets.NEXTDNS_ID }}
